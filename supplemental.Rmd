---
title: "ATB and Steroid contents of other category"
author: "Rebecca Hoyd"
date: "June 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(flextable)
library(UpSetR)
library(glue)
library(tibble)
```

# Load data
```{r}
db <- readRDS("db.RDS")

sterkey <- read.table("steroid-dbid-key.tsv")

sterkey <- sterkey %>%
  select(-Drug.name)

sterkey <- sterkey[!duplicated(sterkey),]

```

# Functions 
```{r}
check.window <- function(vect, per){
  wind <- per[1]:per[2]
  wind <- glue_collapse(as.character(wind), sep = ",|,")
  wind <- paste(",", wind, ",", sep = "")
  ifelse(grepl(pattern = wind, x = vect), 1, 0)
}
```

# Creating needed columns

```{r}
abxclasses <- c("BetaLactam", "Macrolide",  "Other.Antibacterial", "Fluoroquinolone", "Tetracycline", "Vancomycin", "Trimethoprim", "Clindamycin", "Metronidazole")

statesofinterest <- c(abxclasses, as.character(sterkey$Generic.ID))

edges <- c(-28,28)

for(s in statesofinterest){
  db[[paste(s, ".to.start", sep = "")]] <- paste(",", db[[paste(s, ".to.start", sep = "")]], ",", sep = "") 
  db[[s]] <- check.window(db[[paste(s, ".to.start", sep = "")]], edges)
}

db$Other.Steroid <- ifelse(db$Betamthasone == 1 | db$Fludrocortisone == 1 | db$Prednisolone == 1, 1, 0)

db <- db %>%
  mutate(abx.28.28 = check.window(paste(",", abxdays.to.iostart, ",", sep = ""), edges),
         steroid.28.28 = check.window(paste(",", sterdays.to.start, ",", sep = ""), edges))
```

# Table S1)

```{r}
othatb.tab <- db %>%
  filter(!is.na(oth.presc.28)) %>%
  group_by(oth.presc.28) %>%
  tally() %>%
  mutate(ATB = oth.presc.28) %>%
  select(ATB, n)
 

othatb.tab %>%
  flextable()
```

```{r}
#write.csv(othatb.tab, "../tables/supplemental/other-atb-quantities.csv")
```

# Table S2)

```{r}
othster.tab <- db %>%
  filter(Other.Steroid == 1) %>%
  summarise(Betamethasone = sum(Betamthasone),
            Fludrocortisone = sum(Fludrocortisone), 
            Prednisolone = sum(Prednisolone),
            Total = sum(Other.Steroid)) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var = "Steroid") %>%
  mutate(n = as.integer(V1)) %>%
  select(-V1)

othster.tab %>%
  flextable()
```

```{r}
#write.csv(othster.tab, "../tables/supplemental/other-steroid-quantities.csv")
```

# Figure S1)
```{r prep for upset}
meds_iostart <- c("h2b_iostart", "nsaid_iostart", "ppi", "statin", "steroid.28.28", "abx.28.28")

dat.for.upset <- db %>%
  select(meds_iostart)

colnames(dat.for.upset) <- c("H2B", "NSAIDs", "PPI", "Statins", "Steroids", "Antibiotics")
```

```{r save upset, eval = FALSE}
#png("../figures/supplemental/upset_all-meds-confounding.png", units = "in", height = 5, width = 8, res = 600)

upset(dat.for.upset, main.bar.color = "darkred", mainbar.y.label = "Number of Patients", matrix.color = "dark blue", sets.x.label = "")

#dev.off()
```

# Figure S2)
```{r}
dat.for.upset <- db %>%
  select(abxclasses)

colnames(dat.for.upset) <- c("BetaLactam", "Macrolide",  "Other Antibacterial", "Fluoroquinolone", "Tetracycline", "Vancomycin", "Trimethoprim", "Clindamycin", "Metronidazole")
```

```{r, eval = FALSE}
#png("../figures/supplemental/upset_atb.png", units = "in", height = 5, width = 8, res = 600)

upset(dat.for.upset, main.bar.color = "darkred", mainbar.y.label = "Number of Patients", matrix.color = "dark blue", sets.x.label = "", nsets = 9)
#dev.off()
```

# Figure S3)
```{r}
dat.for.upset <- db %>%
  select(Triamcinolone, Prednisone, Hydrocortisone, Methylprednisone, Dexamethosone, Hydrocortisone, Other.Steroid)

colnames(dat.for.upset)[6] <- "Other Steroid"
```

```{r, eval = FALSE}
#png("../figures/supplemental/upset_steroid.png", units = "in", height = 5, width = 8, res = 600)

upset(dat.for.upset, main.bar.color = "darkred", mainbar.y.label = "Number of Patients", matrix.color = "dark blue", sets.x.label = "", nsets = 7)

#dev.off()
```

