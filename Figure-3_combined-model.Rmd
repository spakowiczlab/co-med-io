---
title: 'Figure 3: combined model'
author: "Rebecca Hoyd"
date: "May 13, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survminer)
library(survival)
library(survMisc)
library(ggplot2)
library(dplyr)
library(glue)
```


```{r}
db <- readRDS("db.RDS")
```

```{r}
check.window <- function(vect, per){
  wind <- per[1]:per[2]
  wind <- glue_collapse(as.character(wind), sep = ",|,")
  wind <- paste(",", wind, ",", sep = "")
  ifelse(grepl(pattern = wind, x = vect), 1, 0)
}

db <- db %>%
  mutate(abxdays.to.iostart = paste(",", abxdays.to.iostart, ",", sep = ""),
         sterdays.to.start = paste(",", sterdays.to.start, ",", sep = ""),
         abx.28.28 = check.window(abxdays.to.iostart, c(-28,28)),
         steroid.28.28 = check.window(sterdays.to.start, c(-28,28)))
```

# Survival curves: Abx and Steroid
```{r}
sfit <- survfit(Surv(days, vitalstatus) ~ abx.28.28 + steroid.28.28, data = db)

comb_curv <- ggsurvplot(fit = sfit, conf.int = FALSE, risk.table = TRUE, pval = TRUE, ylab = "", legend = "none", legend.title = "", legend.labs = c("ATB, Steroids=0", "ATB=0,Steroids=1", "ATB=1,Steroids=0", "ATB,Steroids = 1"), font.legend = c(12), fontsize = 6, xlab = "Days", pval.coord = c(0,0.08))

comb_curv
```

```{r}
comb_curv.leg <- ggsurvplot(fit = sfit, conf.int = FALSE, risk.table = TRUE, pval = TRUE, legend = "right", legend.title = "", legend.labs = c("ATB, Steroids=0", "ATB=0,Steroids=1", "ATB=1,Steroids=0", "ATB,Steroids = 1"), font.legend = c(12), fontsize = 6, xlab = "Days", pval.coord = c(0,0.08))

comb_curv.leg
```

```{r}
# ggsave(print(comb_curv), filename = "../figures/Figure-3/combined-curve.png", device = "png")
```

#Combined model
```{r}
db <- db %>%
  mutate(Antibiotics = abx.28.28,
         Steroids = steroid.28.28,
         ECOG = ecog,
         BMI = bmi.calc,
         Sex = sex,
         Age = age,
         `Stage IV` = ifelse(staging == 4, 1, 0),
         CCI = ifelse(comorb.score == 0, 1, ifelse(comorb.score < 3, 2, 3))
         )

cph <- coxph(Surv(days, vitalstatus) ~ Antibiotics + Steroids + ECOG + `Stage IV`+ CCI + BMI + Sex + Age, data = db)

ggforest(cph) 
  # + ggsave("../figures/Figure-3/coxph-ggforest-vis.png")
```