---
title: "Figure-2_details-of-significant-meds"
author: "Rebecca Hoyd"
date: "May 10, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(survival)
library(survminer)
library(glue)
library(RColorBrewer)
library(forcats)
library(broom)
library(ggdendro)
library(gridExtra)
```

```{r load data}
db <- readRDS("db.RDS")

sterkey <- read.table("steroid-dbid-key.tsv")

sterkey <- sterkey %>%
  select(-Drug.name)

sterkey <- sterkey[!duplicated(sterkey),]

```

```{r}
abxclasses <- c("BetaLactam", "Macrolide",  "Other.Antibacterial", "Fluoroquinolone", "Tetracycline", "Vancomycin", "Trimethoprim", "Clindamycin", "Metronidazole")

orgtype <- c("Antibacterial", "Antiviral", "Antifungal")

allcancers <- unique(db$cancer.name)[1:14]
```

# A) Hazard Ratio over time

```{r}
check.window <- function(vect, per){
  wind <- per[1]:per[2]
  wind <- glue_collapse(as.character(wind), sep = ",|,")
  wind <- paste(",", wind, ",", sep = "")
  ifelse(grepl(pattern = wind, x = vect), 1, 0)
}
```

## Part 1: Steroids
```{r, include = FALSE}
sterfloattime <- db %>%
  select(days, vitalstatus, sterdays.to.start) %>%
  mutate(sterdays.to.start = paste(",", sterdays.to.start, ",", sep = ""))

leftanchor <-c(-180:151)
sterwindresults <- list()

i <- 1
sterfloattime$tmp2 <- check.window(sterfloattime$sterdays.to.start, c(leftanchor[i], leftanchor[i] + 29))

for(i in 1:length(leftanchor)){
  j <- leftanchor[i]
  sterfloattime$tmp <- check.window(sterfloattime$sterdays.to.start, c(j, j+29))
  
  sterfloattime <- sterfloattime %>%
    mutate(tmp3 = tmp2 - tmp) %>%
    filter(tmp3 == 0 | tmp3 == -1) %>%
    mutate(tmp2 = tmp)
  
  try({
    survtemp <- coxph(Surv(days, vitalstatus) ~ tmp, data = sterfloattime)
    sterwindresults[[i]] <- survtemp %>%
      tidy() %>%
      mutate(hazard.ratio = exp(estimate),
             low.bound = exp(conf.low),
             upper.bound = exp(conf.high),
             windpval = p.value,
             leftanchor = j) %>%
      select(hazard.ratio, low.bound, upper.bound, leftanchor, windpval)
  })
  
  
}

sterpvaltime <- bind_rows(sterwindresults)
sterpvaltime$leftanchor <- sterpvaltime$leftanchor + 15
```

```{r}
ggplot(data = sterpvaltime, aes(x = leftanchor, y = hazard.ratio)) +
  geom_line() +
  geom_ribbon(aes(ymin = low.bound, ymax = upper.bound), alpha = 0.5, fill = "darkblue") +
  geom_hline(yintercept = 1) +
  labs(title = "Hazard ratio of steroid prescription over time", x = "Time relative to IO start",y = "Hazard Ratio" ) +
  theme_bw() + 
  ggsave("../figures/Figure-2/timing-hr_steroids.png")

```


## Part 2: Antibiotics

```{r, message=FALSE, error=FALSE, warning=FALSE}
abxfloattime <- db %>%
  select(days, vitalstatus, abxdays.to.iostart) %>%
  mutate(abx.days.to.iostart = paste(",", abxdays.to.iostart, ",", sep = ""))

abx.zero.cohort <- db %>%
  select(days, vitalstatus, abx.180.180) %>%
  filter(abx.180.180 == 0) %>%
  mutate(tmp = abx.180.180) %>%
  select(days, vitalstatus, tmp)
leftanchor <-c(-180:151)
abxwindresults <- list()
i <- 1

abxfloattime$tmp2 <- check.window(abxfloattime$abxdays.to.iostart, c(leftanchor[i], leftanchor[i]+29))
  
for(i in 1:length(leftanchor)){
  j <- leftanchor[i]
  abxfloattime$tmp <- check.window(abxfloattime$abxdays.to.iostart, c(j, j+29))
  
  abxfloattime <- abxfloattime %>%
    mutate(tmp3 = tmp2 -tmp) %>%
    filter(tmp3 == 0 | tmp3 == -1) %>%
    mutate(tmp2 = tmp)
  
  abxfloatforsurv <- abxfloattime %>%
    filter(tmp == 1) %>%
    bind_rows(abx.zero.cohort)
  try({
  survtemp <- coxph(Surv(days, vitalstatus) ~ tmp, data = abxfloatforsurv)
  abxwindresults[[i]] <- survtemp %>%
    tidy() %>%
    mutate(hazard.ratio = exp(estimate),
           low.bound = exp(conf.low),
           upper.bound = exp(conf.high), 
           windpval = p.value,
           leftanchor = j) %>%
    select(hazard.ratio, low.bound, upper.bound, windpval, leftanchor)
  })
  
}

abxpvaltime <- bind_rows(abxwindresults)
abxpvaltime$leftanchor <- abxpvaltime$leftanchor + 15
```

```{r}
ggplot(data = abxpvaltime, aes(x = leftanchor, y = hazard.ratio)) +
  geom_line() +
  geom_ribbon(aes(ymin = low.bound, ymax = upper.bound), alpha = 0.5, fill = "darkblue") +
  geom_hline(yintercept = 1) +
  labs(title = "Hazard ratio of ATB prescription over time", x = "Time relative to IO start",y = "Hazard Ratio" ) +
  theme_bw() + 
  ggsave("../figures/Figure-2/timing-hr_atb.png")

```


# B) P.value heatmaps: strongest window

## Create window columns:
```{r}
statesofinterest <- c(abxclasses, orgtype, as.character(sterkey$Generic.ID))

edges <- c(-28,28)

db.heat <- db %>%
  select(days, cancer.name, vitalstatus, one_of(paste(statesofinterest, ".to.start", sep = "")))

for(s in statesofinterest){
  db.heat[[paste(s, ".to.start", sep = "")]] <- paste(",", db.heat[[paste(s, ".to.start", sep = "")]], ",", sep = "") 
  db.heat[[s]] <- check.window(db.heat[[paste(s, ".to.start", sep = "")]], edges)
}
```

## Prepare data for the antibiotic heatmaps

Loop to run all coxph() models and to save other data for the heatmap figures:
```{r}
statesofinterest <- c(abxclasses, orgtype)

curvesbycancer <- list()
sfits <- list()

pvalbycancbac <- list()
pvalbycancorg <- list()

hrbycancbac <- list()
hrbycancorg <- list()

labcolbac <- list()
labcolorg <- list()

patientsbycanc <- list()
patients <- list()

g <- as.formula(paste("Surv(days, vitalstatus) ~ ", glue_collapse(abxclasses, sep = " + "), sep = ""))
h <- as.formula(paste("Surv(days, vitalstatus) ~ ", glue_collapse(orgtype, sep = " + "), sep = ""))

for(c in allcancers){
  
  tmp <- subset(db.heat, db.heat$cancer.name == c)
  
  x <- coefficients(summary(coxph(formula = g, data = tmp)))
  y <- coefficients(summary(coxph(formula = h, data = tmp)))

    hrbycancbac[[c]] <- round(x[,2], 2)
    labcolbac[[c]] <- ifelse(x[,2] < 1, "red", "black")
    pvalbycancbac[[c]] <- x[,5]
    
    hrbycancorg[[c]] <- round(y[,2], 2)
    labcolorg[[c]] <- ifelse(y[,2] < 1, "red", "black")
    pvalbycancorg[[c]] <- y[,5]
    
  for(s in statesofinterest){
    n1 <- sum(tmp[,s], na.rm = TRUE)
    n0 <- tmp[tmp[s] == 0,]
    n0 <- length(n0$days)
    f <- as.formula(paste("Surv(days, vitalstatus) ~ ", s, sep = ""))
    patients[[s]] <- paste(n0, n1, sep = ", ")
    
  }
  patientsbycanc[[c]] <- patients

  patients <- list()
  
}

perorgcancpvals <- bind_rows(pvalbycancorg) %>%
  t() %>%
  as.data.frame()
colnames(perorgcancpvals) <- names(pvalbycancorg$melanoma)

perclasscancpvals <- bind_rows(pvalbycancbac) %>%
  t() %>%
  as.data.frame()
colnames(perclasscancpvals) <- names(pvalbycancbac$melanoma)

patientsbycanc <- bind_rows(patientsbycanc)
rownames(patientsbycanc) <- names(pvalbycancbac)

labcolbac <- bind_rows(labcolbac) %>%
  t() %>%
  as.data.frame()
colnames(labcolbac) <- names(hrbycancbac$Other)

labcolorg <- bind_rows(labcolorg) %>%
  t() %>%
  as.data.frame()
colnames(labcolorg) <- names(hrbycancorg$Other)

stickersbycancbac <- lapply(hrbycancbac, function(x) lapply(x, function(y) ifelse(y > 10, ">10", y)))
stickersbycancbac <- lapply(stickersbycancbac, function(x) lapply(x, function(y) as.character(y)))
stickersbycancbac <- bind_rows(stickersbycancbac)
rownames(stickersbycancbac) <- names(hrbycancbac)

stickersbycancorg <- lapply(hrbycancorg, function(x) lapply(x, function(y) ifelse(y > 10, ">10", y)))
stickersbycancorg <- lapply(stickersbycancorg, function(x) lapply(x, function(y) as.character(y)))
stickersbycancorg <- bind_rows(stickersbycancorg)
rownames(stickersbycancorg) <- names(hrbycancorg)

```

Code manipulating data into long format for the creation of figures, and saving a data frame object that will be used for the heatmap.
```{r}
perclasspat <- patientsbycanc %>%
  select(-Antifungal, -Antiviral, -Antibacterial) %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "AbxClass", value = "ns", -cancer)

perorgpats <- patientsbycanc %>%
  select(Antifungal, Antiviral, Antibacterial) %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "AbxClass", value = "ns", -cancer)

labcolorg <- labcolorg %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "AbxClass", value = "labcol", -cancer) %>%
  mutate(labcol = ifelse(is.na(labcol), "black", labcol))

labcolbac <- labcolbac %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "AbxClass", value = "labcol", -cancer) %>%
  mutate(labcol = ifelse(is.na(labcol), "black", labcol))

stickersbycancbac <- stickersbycancbac %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "AbxClass", value = "hazrat", -cancer) %>%
  full_join(perclasspat) %>%
  mutate(labtext = paste(ns, hazrat, sep = "\n"))

stickersbycancorg <- stickersbycancorg %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "AbxClass", value = "hazrat", -cancer) %>%
  full_join(perorgpats) %>%
  mutate(labtext = paste(ns, hazrat, sep = "\n"))

heatorg <- as.data.frame(perorgcancpvals)  %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "AbxClass", value = "p.value", -cancer) %>%
  full_join(stickersbycancorg) %>%
  full_join(labcolorg)

heatclass <- as.data.frame(perclasscancpvals)  %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "AbxClass", value = "p.value", -cancer) %>%
  full_join(stickersbycancbac) %>%
  full_join(labcolbac)
```

## Prepare data for the steroid heatmaps

```{r, message=FALSE, warning=FALSE}
sterdbid <- as.character(sterkey$Generic.ID[1:8])

dbidcurvesbycancer <- list()

dbidpvalbycancer <- list()

dbidhrbycanc <- list()

dbidlabcol <- list()

dbidpatientsbycanc <- list()
patients <- list()

g <- as.formula(paste("Surv(days, vitalstatus) ~ ", glue_collapse(sterdbid, sep = " + "), sep = ""))

for (c in allcancers) {
  tmp <- subset(db.heat, db.heat$cancer.name == c)
  
  x <- coefficients(summary(coxph(formula = g, data = tmp)))
  dbidhrbycanc[[c]] <- round(x[,2], 2)
  dbidlabcol[[c]] <- ifelse(x[,2] < 1, "red", "black")
  dbidpvalbycancer[[c]] <- x[,5]
      
  for (s in sterdbid){
    n1 <- sum(tmp[,s], na.rm = TRUE)
    n0 <- tmp[tmp[s] == 0,]
    n0 <- length(n0$days)
    patients[[s]] <- paste(n0, n1, sep = ", ")
    
  }
  
  dbidpatientsbycanc[[c]] <- patients

  patients <- list()
  
}


dbidallcancpvals <- bind_rows(dbidpvalbycancer) %>%
  t() %>%
  as.data.frame()
colnames(dbidallcancpvals) <- names(dbidpvalbycancer$melanoma)

dbidpatientsbycanc <- bind_rows(dbidpatientsbycanc)
rownames(dbidpatientsbycanc) <- names(dbidpvalbycancer)

dbidlabcol <- bind_rows(dbidlabcol) %>%
  t() %>%
  as.data.frame()
colnames(dbidlabcol) <- names(dbidhrbycanc$Other)

dbidstickersbycanc <- lapply(dbidhrbycanc, function(x) lapply(x, function(y) ifelse(y > 10, ">10", y)))
dbidstickersbycanc <- lapply(dbidstickersbycanc, function(x) lapply(x, function(y) as.character(y)))
dbidstickersbycanc <- bind_rows(dbidstickersbycanc)
rownames(dbidstickersbycanc) <- names(dbidhrbycanc)
```


Manipulating the data output by the steroid loop into long format, and creating the dataframe for the heatmap:
```{r}
dbidpat <- dbidpatientsbycanc %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "Steroid.ID", value = "ns", -cancer)

dbidlabcol <- dbidlabcol %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "Steroid.ID", value = "labcol", -cancer) %>%
  mutate(labcol = ifelse(is.na(labcol), "black", labcol))

dbidstickersbycanc <- dbidstickersbycanc %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "Steroid.ID", value = "hazrat", -cancer) %>%
  full_join(dbidpat) %>%
  mutate(labtext = paste(ns, hazrat, sep = "\n"))

heatster <- as.data.frame(dbidallcancpvals)  %>%
  rownames_to_column(var = "cancer") %>%
  gather(key = "Steroid.ID", value = "p.value", -cancer) %>%
  full_join(dbidstickersbycanc) %>%
  full_join(dbidlabcol) %>%
  mutate(labtext = as.character(labtext)) 
```

## Create dendrograms for the heatmaps

Antibacerials:
```{r}
hrforclustbac <- bind_rows(hrbycancbac) %>%
  as.data.frame()

rownames(hrforclustbac) <- names(hrbycancbac$Other)

hrforclustbac <- sapply(hrforclustbac, function(x) ifelse(x > 65000, 65000, x))
hrforclustbac <- apply(hrforclustbac, 2, function(x) ifelse(is.na(x), 1, x))
rownames(hrforclustbac) <- names(hrbycancbac$Other)
hrforclustbac <- dist(hrforclustbac)

bactree <- hclust(hrforclustbac)
bactree <- as.dendrogram(bactree)
bactree <- dendro_data(bactree)

bacorder <- as.character(bactree$labels$label)

dendplot <- ggdendrogram(bactree, rotate = FALSE, labels = FALSE) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank())

cancclust <- bind_rows(hrbycancbac) %>%
  t() %>%
  as.data.frame

cancclust <- sapply(cancclust, function(x) ifelse(x > 65000, 65000, x))
cancclust <- apply(cancclust, 2, function(x) ifelse(is.na(x), 1, x))
colnames(cancclust) <- names(hrbycancbac$Other)
rownames(cancclust) <- names(hrbycancbac)

cancclust <- dist(cancclust)
cancclust <- hclust(cancclust)
canctree <- dendro_data(as.dendrogram(cancclust))
```

Steroids:
```{r}

dbidforclust <- bind_rows(dbidhrbycanc) %>%
  as.data.frame() 

rownames(dbidforclust) <- names(dbidhrbycanc$Other)

dbidforclust <- sapply(dbidforclust, function(x) ifelse(x > 65000, 65000, x))
dbidforclust <- apply(dbidforclust, 2, function(x) ifelse(is.na(x), 1, x))

rownames(dbidforclust) <- names(dbidhrbycanc$Other)

dbidsterclust <- dist(dbidforclust)
dbidtree <- hclust(dbidsterclust)
dbidtree <- dendro_data(as.dendrogram(dbidtree))

dbiddendplot <- ggdendrogram(dbidtree, rotate = FALSE, size = 10, labels = FALSE) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank())

dbidcancclust <- t(dbidforclust) %>%
  dist() %>%
  hclust()
dbidcanctree <- dendro_data(as.dendrogram(dbidcancclust))
```

# Construct Heatmaps

Build the heatmap for the antibacterials:
```{r}

heatplot <- heatclass %>%
  ggplot(aes(fct_relevel(AbxClass, bacorder), fct_relevel(cancer, as.character(canctree$labels$label)))) +
  geom_tile(aes(fill = p.value )) +
  geom_label(aes(label = labtext, colour = fct_relevel(labcol, "red", "black")), size = 1.8) +
  scale_colour_manual(name = "Hazard Ratio", breaks = c("red", "black"), labels = c("<1", ">=1"), values = c("red", "black")) +
  labs(x = "", y = "") +
  scale_fill_distiller(guide = "legend", breaks = c(0.00000001, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.2, 0.5, 1), limits = c(0, 1), values = c(0.00000001, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.2, 0.5, 1), type = "div", palette = "RdBu", direction = 1, labels = c("<0.01", "0.01", "0.02","0.03", "0.04","0.05","0.1", "0.2", "0.5", "1")) +
  scale_x_discrete(breaks = bacorder, labels = replace(bacorder, which(bacorder == "Other.Antibacterial"), "Other Antibacerial")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 10))

```

Construct heatmap for steroids:
```{r}
dbidheatplot <- heatster %>%
  ggplot(aes(fct_relevel(Steroid.ID, as.character(dbidtree$labels$label)), fct_relevel(cancer, as.character(dbidcanctree$labels$label)))) +
  geom_tile(aes(fill = p.value)) +
  geom_label(aes(label = labtext, colour = fct_relevel(labcol, "red", "black")), size = 1.5) +
  scale_colour_manual(name = "Hazard Ratio", breaks = c("red", "black"), labels = c("<1", ">=1"), values = c("red", "black")) +
  labs(x = "", y = "") +
  scale_fill_distiller(guide = "legend", breaks = c(0.00000000001, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.2, 0.5, 1), limits = c(0, 1), values = c(0.00000000001, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.2, 0.5, 1), type = "div", palette = "RdBu", direction = 1, labels = c("<0.01", "0.01", "0.02","0.03", "0.04","0.05","0.1", "0.2", "0.5", "1")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```


Combine heatmaps and dendrograms, display and save:

```{r}

test <- grid.arrange(
  grobs = list(dendplot, heatplot),
  widths = c(.9,2,.65),
  heights = c(1, 3),
  layout_matrix = rbind(c(NA, 1, NA),
                        c(2,2,2))
) 

ggsave(plot = test, "../figures/Figure-2/heatmap_clustered-abx-classes.png", device = "png", height = 10, width = 8)
```


```{r}

test2 <- grid.arrange(
  grobs = list(dbiddendplot, dbidheatplot),
  widths = c(.9,2,.7),
  heights = c(1, 3),
  layout_matrix = rbind(c(NA, 1, NA),
                        c(2,2,2))
) 

ggsave(plot = test2, "../figures/Figure-2/heatmap_clustered-steroids.png", device = "png", height = 10, width = 7)
```


# Store information on hazard ratios from the antibiotics data

```{r}
hazardrats <- bind_rows(hrbycancbac) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var = "cancer")

colnames(hazardrats) <- c("cancer", names(hrbycancbac$Other))

hazardrats <- hazardrats %>%
  gather(-cancer, key = "AbxClass", value = "HazardRatio")
```

```{r}

choosecomps <- heatclass %>%
  separate(labtext, into = c("n0", "further"), sep = ", ", remove = TRUE) %>%
  separate(further, into = c("n1", "noneed"), sep = "\n", remove = TRUE) %>%
  mutate(n0 = as.numeric(as.character(n0))) %>%
  mutate(n1 = as.numeric(as.character(n1)))

choosecomps <- choosecomps %>%
  select(cancer, AbxClass, n1, n0) %>%
  filter(n1 >= 3) %>%
  filter(n0 >= 3)


hazardrats <- choosecomps %>%
  select(-n1,-n0) %>%
  left_join(hazardrats) %>%
  spread(key = AbxClass, value = HazardRatio)

rownames(hazardrats) <- hazardrats$cancer
hazardrats <- hazardrats[,-1]

hazardrats <- hazardrats[c(1,3,5,6,8,9,10), ]
```

```{r}
Median.HR  <- lapply(hazardrats, function(x) median(x, na.rm = TRUE))

Median.HR <- bind_rows(Median.HR)
```

```{r ranks of the classes in cancers}
rankinghrs <- t(hazardrats) %>%
  as.data.frame()
rankinghrs <- -rankinghrs
rankinghrs <- lapply(rankinghrs, function(x) as.factor(x))
rankinghrs <- lapply(rankinghrs, function(x) as.numeric(x))
rankinghrs <- bind_cols(rankinghrs) %>%
  as.data.frame()

rownames(rankinghrs) <- colnames(hazardrats)
rankinghrs <- t(rankinghrs) %>%
  as.data.frame()
```

```{r}
Times.Worst <- lapply(rankinghrs, function(x) {length(subset(x, x == 1))})

Times.Worst <- bind_rows(Times.Worst)

Times.Worst.3 <- lapply(rankinghrs, function(x) {length(subset(x, x <= 3))})

Times.Worst.3 <- bind_rows(Times.Worst.3)

Average.Rank <- lapply(rankinghrs, function(x) mean(x, na.rm = TRUE))

Average.Rank <- bind_rows(Average.Rank)

sumaryhazardranks <- rbind(Times.Worst = Times.Worst, Times.Worst.3 = Times.Worst.3, Average.Rank = Average.Rank,Median.HR = Median.HR) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var = "Antibacterial") %>%
  arrange(Average.Rank)

```

```{r}
saveRDS(sumaryhazardranks, "hazard-table.RDS")
```