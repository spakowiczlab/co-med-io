filter(days.abx.to.iostart >= -180 & days.abx.to.iostart <= 180) %>%
mutate(organism.type = paste(organism.type, ".to.start", sep = ""),
abxClass = paste(abxClass, ".to.start", sep = ""))
abx.org.days <- abx.all.days %>%
group_by(record_id, organism.type) %>%
summarise(days.to.start = glue_collapse(unique(days.abx.to.iostart), sep = ",")) %>%
spread(key = "organism.type", value = "days.to.start")
abx.class.days <- abx.all.days %>%
group_by(record_id, abxClass) %>%
summarise(days.to.start = glue_collapse(unique(days.abx.to.iostart), sep = ",")) %>%
spread(key = "abxClass", value = "days.to.start") %>%
select(-Antifungal.to.start, -Antiviral.to.start)
db2 <- db2 %>%
left_join(abx.org.days) %>%
left_join(abx.class.days)
abx.60.60meds <- meds %>%
filter(abx.60.60 == 1)
abx.60.60meds <- abx.60.60meds %>%
mutate(BetaLactam = ifelse(abxClass == "BetaLactam", 1, 0))%>%
mutate(Macrolide = ifelse(abxClass == "Macrolide", 1, 0))%>%
mutate(Other.Antibacterial = ifelse(Antibiotic =="Sulfamethoxazole"| Antibiotic == "Linezolid"| Antibiotic == "Daptomycin", 1, 0))%>%
mutate(Fluoroquinolone = ifelse(abxClass == "FQ", 1, 0))%>%
mutate(Tetracycline = ifelse(abxClass == "Tetracycline", 1, 0))%>%
mutate(Acyclovir = ifelse(Antibiotic == "Acyclovir", 1, 0)) %>%
mutate(Valacyclovir = ifelse(Antibiotic == "Valacyclovir", 1, 0)) %>%
mutate(Metronidazole = ifelse(Antibiotic == "Metronidazole",1,0)) %>%
mutate(Vancomycin = ifelse(Antibiotic == "Vancomycin", 1, 0)) %>%
mutate(Trimethoprim = ifelse(Antibiotic == "Trimethoprim", 1, 0)) %>%
mutate(Clindamycin = ifelse(Antibiotic == "Clindamycin", 1, 0)) %>%
mutate(Antibacterial = ifelse(organism.type == "Antibacterial", 1, 0)) %>%
mutate(Antifungal = ifelse(organism.type == "Antifungal", 1, 0)) %>%
mutate(Antiviral = ifelse(organism.type == "Antiviral", 1, 0)) %>%
dplyr::select(record_id, BetaLactam, Macrolide, Other.Antibacterial, Fluoroquinolone, Vancomycin, Trimethoprim, Clindamycin, Metronidazole, Tetracycline, Antibiotic, Antibacterial, Antiviral, Antifungal, Acyclovir, Valacyclovir, abxClass)
abxforjoin <- abx.60.60meds %>%
group_by(record_id) %>%
summarise(BetaLactam = binarize(BetaLactam),
Macrolide = binarize(Macrolide),
Fluoroquinolone = binarize(Fluoroquinolone),
Tetracycline = binarize(Tetracycline),
Other.Antibacterial = binarize(Other.Antibacterial),
Vancomycin = binarize(Vancomycin),
Trimethoprim = binarize(Trimethoprim),
Clindamycin = binarize(Clindamycin),
Metronidazole = binarize(Metronidazole),
Antibacterial = binarize(Antibacterial),
Antiviral = binarize(Antiviral),
Antifungal = binarize(Antifungal),
Acyclovir = binarize(Acyclovir),
Valacyclovir = binarize(Valacyclovir)
)
db <- db %>%
left_join(abxforjoin) %>%
ungroup() %>%
mutate(
BetaLactam = narem(BetaLactam),
Macrolide = narem(Macrolide),
Fluoroquinolone = narem(Fluoroquinolone),
Tetracycline = narem(Tetracycline),
Other.Antibacterial = narem(Other.Antibacterial),
Vancomycin = narem(Vancomycin),
Trimethoprim = narem(Trimethoprim),
Clindamycin = narem(Clindamycin),
Metronidazole = narem(Metronidazole),
Antibacterial = narem(Antibacterial),
Antiviral = narem(Antiviral),
Antifungal = narem(Antifungal),
Acyclovir = narem(Acyclovir),
Valacyclovir = narem(Valacyclovir)
)
meds$abx.plus.60 <- ifelse(meds$days.abx.to.iostart >= -0 & meds$days.abx.to.iostart <= 60, 1, 0)
abxplus.60meds <- meds %>%
filter(abx.plus.60 == 1)
abxplus.60Class <- unique(abxplus.60meds$abxClass)
abxplus.60meds <- abxplus.60meds %>%
mutate(BetaLactamplus = ifelse(abxClass == "BetaLactam", 1, 0))%>%
mutate(Macrolideplus = ifelse(abxClass == "Macrolide", 1, 0))%>%
mutate(Other.Antibacterialplus = ifelse(Antibiotic =="Sulfamethoxazole"| Antibiotic == "Linezolid"| Antibiotic == "Daptomycin", 1, 0))%>%
mutate(Fluoroquinoloneplus = ifelse(abxClass == "FQ", 1, 0))%>%
mutate(Tetracyclineplus = ifelse(abxClass == "Tetracycline", 1, 0))%>%
mutate(Acyclovirplus = ifelse(Antibiotic == "Acyclovir", 1, 0)) %>%
mutate(Valacyclovirplus = ifelse(Antibiotic == "Valacyclovir", 1, 0)) %>%
mutate(Metronidazoleplus = ifelse(Antibiotic == "Metronidazole",1,0)) %>%
mutate(Vancomycinplus = ifelse(Antibiotic == "Vancomycin", 1, 0)) %>%
mutate(Trimethoprimplus = ifelse(Antibiotic == "Trimethoprim", 1, 0)) %>%
mutate(Clindamycinplus = ifelse(Antibiotic == "Clindamycin", 1, 0)) %>%
mutate(Antibacterialplus = ifelse(organism.type == "Antibacterial", 1, 0)) %>%
mutate(Antifungalplus = ifelse(organism.type == "Antifungal", 1, 0)) %>%
mutate(Antiviralplus = ifelse(organism.type == "Antiviral", 1, 0)) %>%
dplyr::select(record_id, BetaLactamplus, Macrolideplus, Other.Antibacterialplus, Fluoroquinoloneplus, Vancomycinplus, Trimethoprimplus, Clindamycinplus, Metronidazoleplus, Tetracyclineplus, Antibacterialplus, Antiviralplus, Antifungalplus, Acyclovirplus, Valacyclovirplus, abxClass)
abxplusforjoin <- abxplus.60meds %>%
group_by(record_id) %>%
summarise(BetaLactamplus = binarize(BetaLactamplus),
Macrolideplus = binarize(Macrolideplus),
Fluoroquinoloneplus = binarize(Fluoroquinoloneplus),
Tetracyclineplus = binarize(Tetracyclineplus),
Other.Antibacterialplus = binarize(Other.Antibacterialplus),
Vancomycinplus = binarize(Vancomycinplus),
Trimethoprimplus = binarize(Trimethoprimplus),
Clindamycinplus = binarize(Clindamycinplus),
Metronidazoleplus = binarize(Metronidazoleplus),
Antibacterialplus = binarize(Antibacterialplus),
Antiviralplus = binarize(Antiviralplus),
Antifungalplus = binarize(Antifungalplus),
Acyclovirplus = binarize(Acyclovirplus),
Valacyclovirplus = binarize(Valacyclovirplus)
)
db <- db %>%
left_join(abxplusforjoin) %>%
ungroup() %>%
mutate(BetaLactamplus = narem(BetaLactamplus),
Macrolideplus = narem(Macrolideplus),
Fluoroquinoloneplus = narem(Fluoroquinoloneplus),
Tetracyclineplus = narem(Tetracyclineplus),
Other.Antibacterialplus = narem(Other.Antibacterialplus),
Vancomycinplus = narem(Vancomycinplus),
Trimethoprimplus = narem(Trimethoprimplus),
Clindamycinplus = narem(Clindamycinplus),
Metronidazoleplus = narem(Metronidazoleplus),
Antibacterialplus = narem(Antibacterialplus),
Antiviralplus = narem(Antiviralplus),
Antifungalplus = narem(Antifungalplus),
Acyclovirplus = narem(Acyclovirplus),
Valacyclovirplus = narem(Valacyclovirplus))
abxless.60meds <- meds %>%
filter(abx.60 == 1)
abxless.60meds <- abxless.60meds %>%
mutate(BetaLactamless = ifelse(abxClass == "BetaLactam", 1, 0))%>%
mutate(Macrolideless = ifelse(abxClass == "Macrolide", 1, 0))%>%
mutate(Other.Antibacterialless = ifelse(Antibiotic =="Sulfamethoxazole"| Antibiotic == "Linezolid"| Antibiotic == "Daptomycin", 1, 0))%>%
mutate(Fluoroquinoloneless = ifelse(abxClass == "FQ", 1, 0))%>%
mutate(Tetracyclineless = ifelse(abxClass == "Tetracycline", 1, 0))%>%
mutate(Acyclovirless = ifelse(Antibiotic == "Acyclovir", 1, 0)) %>%
mutate(Valacyclovirless = ifelse(Antibiotic == "Valacyclovir", 1, 0)) %>%
mutate(Metronidazoleless = ifelse(Antibiotic == "Metronidazole",1,0)) %>%
mutate(Vancomycinless = ifelse(Antibiotic == "Vancomycin", 1, 0)) %>%
mutate(Trimethoprimless = ifelse(Antibiotic == "Trimethoprim", 1, 0)) %>%
mutate(Clindamycinless = ifelse(Antibiotic == "Clindamycin", 1, 0)) %>%
mutate(Antibacterialless = ifelse(organism.type == "Antibacterial", 1, 0)) %>%
mutate(Antifungalless = ifelse(organism.type == "Antifungal", 1, 0)) %>%
mutate(Antiviralless = ifelse(organism.type == "Antiviral", 1, 0)) %>%
dplyr::select(record_id, BetaLactamless, Macrolideless, Other.Antibacterialless, Fluoroquinoloneless, Vancomycinless, Trimethoprimless, Clindamycinless, Metronidazoleless, Tetracyclineless, Antibiotic, Antibacterialless, Antiviralless, Antifungalless, Acyclovirless, Valacyclovirless, abxClass)
abxlessforjoin <- abxless.60meds %>%
group_by(record_id) %>%
summarise(BetaLactamless = binarize(BetaLactamless),
Macrolideless = binarize(Macrolideless),
Fluoroquinoloneless = binarize(Fluoroquinoloneless),
Tetracyclineless = binarize(Tetracyclineless),
Other.Antibacterialless = binarize(Other.Antibacterialless),
Vancomycinless = binarize(Vancomycinless),
Trimethoprimless = binarize(Trimethoprimless),
Clindamycinless = binarize(Clindamycinless),
Metronidazoleless = binarize(Metronidazoleless),
Antibacterialless = binarize(Antibacterialless),
Antiviralless = binarize(Antiviralless),
Antifungalless = binarize(Antifungalless),
Acyclovirless = binarize(Acyclovirless),
Valacyclovirless = binarize(Valacyclovirless)
)
db <- db %>%
left_join(abxlessforjoin) %>%
ungroup() %>%
mutate(BetaLactamless = narem(BetaLactamless),
Macrolideless = narem(Macrolideless),
Fluoroquinoloneless = narem(Fluoroquinoloneless),
Tetracyclineless = narem(Tetracyclineless),
Other.Antibacterialless = narem(Other.Antibacterialless),
Vancomycinless = narem(Vancomycinless),
Trimethoprimless = narem(Trimethoprimless),
Clindamycinless = narem(Clindamycinless),
Metronidazoleless = narem(Metronidazoleless),
Antibacterialless = narem(Antibacterialless),
Antiviralless = narem(Antiviralless),
Antifungalless = narem(Antifungalless),
Acyclovirless = narem(Acyclovirless),
Valacyclovirless = narem(Valacyclovirless))
admins <- unique(meds$ROUTE)[-1]
admins
meds.admins <- meds %>%
filter(abx.60.60 == 1) %>%
mutate(Oral = ifelse(ROUTE == "Oral", 1, 0),
Intravenous = ifelse(ROUTE == "Intravenous", 1, 0),
Otic = ifelse(ROUTE == "Otic", 1, 0),
Injection = ifelse(ROUTE == "Injection", 1, 0),
Ophthalmic = ifelse(ROUTE == "Ophthalmic", 1, 0),
External = ifelse(ROUTE == "Apply externally", 1, 0),
Unknown = ifelse(ROUTE == "Unknown", 1, 0),
Vaginal = ifelse(ROUTE == "Vaginal", 1, 0),
Intramuscular = ifelse(ROUTE == "Intramuscular", 1, 0))
meds.admins <- meds.admins %>%
group_by(MRN) %>%
summarise(Oral = binarize(Oral),
Intravenous = binarize(Intravenous),
Otic = binarize(Otic),
Injection = binarize(Injection),
Ophthalmic = binarize(Ophthalmic),
External = binarize(External),
Unknown = binarize(Unknown),
Vaginal = binarize(Vaginal),
Intramuscular = binarize(Intramuscular)) %>%
mutate(record_id = as.character(MRN)) %>%
select(-MRN)
db <- db %>%
left_join(meds.admins) %>%
mutate(Oral = narem(Oral),
Intravenous = narem(Intravenous),
Otic = narem(Otic),
Injection = narem(Injection),
Ophthalmic = narem(Ophthalmic),
External = narem(External),
Unknown.ATB.Route = narem(Unknown),
Vaginal = narem(Vaginal),
Intramuscular = narem(Intramuscular)) %>%
dplyr::select(-Unknown)
iostart <- db %>%
select(record_id, iostart) %>%
mutate(iostart = as.Date(iostart, format = "%F")) %>%
mutate(MRN = record_id) %>%
select(-record_id)
steroids <- steroids %>%
mutate(MRN = as.character(MRN)) %>%
left_join(iostart)
steroids$iostart <- as.Date(steroids$iostart, format = "%F")
steroids$START_DATE <- as.Date(steroids$START_DATE, formate = "%F")
steroids$days.to.iostart <- steroids$START_DATE - steroids$iostart
steroids <- steroids %>%
filter(!is.na(days.to.iostart)) %>%
mutate(ster.30 = ifelse(days.to.iostart > -30 & days.to.iostart <= 0, 1, 0)) %>%
mutate(ster.30.30 = ifelse(days.to.iostart > -30 & days.to.iostart <= 30, 1, 0)) %>%
mutate(ster.60 = ifelse(days.to.iostart > -60 & days.to.iostart <= 0, 1, 0)) %>%
mutate(ster.60.60 = ifelse(days.to.iostart > -60 & days.to.iostart <= 60, 1, 0)) %>%
mutate(ster.180.180 = ifelse(days.to.iostart > -180 & days.to.iostart <= 180, 1, 0))
db <-
steroids %>%
mutate(record_id = MRN) %>%
select(-MRN) %>%
group_by(record_id) %>%
summarise(ster.30 = binarize(ster.30),
ster.30.30 = binarize(ster.30.30),
ster.60 = binarize(ster.60),
ster.60.60 = binarize(ster.60.60),
ster.180.180 = binarize(ster.180.180)
) %>%
left_join(db, .)
daysstring <- steroids %>%
mutate(record_id = MRN) %>%
filter(days.to.iostart >= -180 & days.to.iostart <= 180) %>%
select(-MRN) %>%
group_by(record_id) %>%
summarise(sterdays.to.start = glue_collapse(unique(days.to.iostart), sep = ","))
db <- db %>%
left_join(daysstring)
db2 <- db2 %>%
left_join(daysstring)
sterroute <- c("Injection", "Oral", "Apply externally", "Rectal", "Ophthalmic", "Unknown", "Otic" )
sterclass <- c("IV", "Oral", rep("Other.route", 5))
sterassign <- as.data.frame(cbind(sterroute, sterclass)) %>%
mutate(sterroute = as.character(sterroute),
sterclass = as.character(sterclass))
classes <- vector(length = length(steroids$GENERIC_NAME))
for(i in 1:length(sterroute)){
x <- grep(x = steroids$ROUTE, pattern = sterroute[i], ignore.case = TRUE)
classes[x] <- sterassign[i, 2]
}
check <- as.data.frame(cbind(steroids$ROUTE, classes))
y <- grep(check[,2], pattern = "FALSE", ignore.case = TRUE)
check[y, "classes"] <- NA
sterforfun <- vector(length = length(steroids$GENERIC_NAME))
sterdrugname <- sterfun$Drug.name
i <- 5
for(i in 1:length(sterdrugname)){
x <- grep(x = steroids$GENERIC_NAME, pattern = sterdrugname[i], ignore.case = TRUE)
sterforfun[x] <- as.character(sterfun[i,1])
}
check <- as.data.frame(cbind(steroids$GENERIC_NAME, sterforfun))
y <- grep(check[,2], pattern = "FALSE", ignore.case = TRUE)
check[y,]
steroids$sterclass <- classes
steroids$sterforfun <- sterforfun
# sternames <- c("cortisone", "cortef", "hydrocortisone", "prednisone", "prednisolone", "orapred", "prelone", "triamcinolone", "aristospan", "kenalog", "dexamethasone", "dexpak", "fludrocortisone", "florinef", "betamethasone", "celestone", "methylprednisolone", "medrol", "depo.medrol", "solu.medrol")
sternames <- c("IV", "Oral", "Other.route",unique(as.character(sterfun$DBID)))
ster60.60meds <- steroids %>%
filter(abs(days.to.iostart) <= 60)
ster60.60meds <- ster60.60meds %>%
mutate(IV = ifelse(sterclass == "IV", 1, 0))%>%
mutate(Oral = ifelse(sterclass == "Oral", 1, 0))%>%
mutate(Other.route = ifelse(sterclass == "Other.route", 1, 0))%>%
mutate(record_id = MRN) %>%
mutate(DB00443 = ifelse(sterforfun == "DB00443",1,0)) %>%
mutate(DB00620 = ifelse(sterforfun == "DB00620",1,0)) %>%
mutate(DB00635 = ifelse(sterforfun == "DB00635",1,0)) %>%
mutate(DB00687 = ifelse(sterforfun == "DB00687",1,0)) %>%
mutate(DB00741 = ifelse(sterforfun == "DB00741",1,0)) %>%
mutate(DB00860 = ifelse(sterforfun == "DB00860",1,0)) %>%
mutate(DB00959 = ifelse(sterforfun == "DB00959",1,0)) %>%
mutate(DB01234 = ifelse(sterforfun == "DB01234",1,0)) %>%
mutate(DB14631 = ifelse(sterforfun == "DB14631",1,0)) %>%
mutate(DB14681 = ifelse(sterforfun == "DB14681",1,0)) %>%
dplyr::select(record_id, one_of(sternames))
db <- ster60.60meds %>%
group_by(record_id) %>%
summarise(IV = binarize(IV),
Oral = binarize(Oral),
Other.route = binarize(Other.route),
DB00443 = binarize(DB00443),
DB00620 = binarize(DB00620),
DB00635 = binarize(DB00635),
DB00687 = binarize(DB00687),
DB00741 = binarize(DB00741),
DB00860 = binarize(DB00860),
DB00959 = binarize(DB00959),
DB01234 = binarize(DB01234),
DB14631 = binarize(DB14631),
DB14681 = binarize(DB14681)) %>%
left_join(db, .)
db <- db %>%
mutate(IV = narem(IV),
Oral = narem(Oral),
Other.route = narem(Other.route),
DB00443 = narem(DB00443),
DB00620 = narem(DB00620),
DB00635 = narem(DB00635),
DB00687 = narem(DB00687),
DB00741 = narem(DB00741),
DB00860 = narem(DB00860),
DB00959 = narem(DB00959),
DB01234 = narem(DB01234),
DB14631 = narem(DB14631),
DB14681 = narem(DB14681)
)
ster.class.time <- steroids %>%
mutate(record_id = MRN,
DBID = sterforfun) %>%
select(-MRN) %>%
filter(ster.180.180 == 1) %>%
left_join(stergenkey) %>%
mutate(Generic.ID = paste(Generic.ID, ".to.start", sep = "")) %>%
group_by(record_id, Generic.ID) %>%
summarise(days.to.start = glue_collapse(unique(days.to.iostart), sep = ",")) %>%
spread(key = "Generic.ID", value = "days.to.start")
db2 <- db2 %>%
left_join(ster.class.time)
unique(steroids$STRENGTH)
steroids.sep.strength <- steroids %>%
select(MRN, MED_DESCRIPTION, STRENGTH, sterforfun, days.to.iostart) %>%
arrange(MED_DESCRIPTION) %>%
mutate(DBID = sterforfun) %>%
left_join(stergenkey) %>%
select(-DBID, -sterforfun) %>%
separate(STRENGTH, c("unit_count", "unit_size"), extra = "drop", sep = " ", remove = FALSE)
steroids.mg <- steroids.sep.strength %>%
filter(unit_size == "MG") %>%
mutate(unit_count = as.numeric(unit_count))
unique(steroids.mg$Generic.ID)
(length(steroids.sep.strength$MED_DESCRIPTION) - length(steroids.mg$MED_DESCRIPTION))/length(steroids.sep.strength$MED_DESCRIPTION)
Generic.ID <- c("Cortisone", "Hydrocortisone", "Prednisolone", "Prednisone", "Triamcinolone", "Methylprednisone", "Betamethasone", "Dexamethosone")
pred.equiv <- c(.20,.25,1,1,1.25,1.25,6.25,6.25)
sterstrengthkey <- as.data.frame(cbind(Generic.ID, pred.equiv))
steroids.mg.scaled <- steroids.mg %>%
left_join(sterstrengthkey) %>%
mutate(pred.equiv = as.numeric(as.character(pred.equiv))) %>%
mutate(Prednisone.Equivalent = unit_count * pred.equiv)
stratcuts <- c(10,20,25,40,80)
doseconstruct <- list()
for(s in stratcuts){
doseconstruct[[s]] <- steroids.mg.scaled %>%
filter(Prednisone.Equivalent >= s) %>%
filter(days.to.iostart < 180 & days.to.iostart > -180) %>%
group_by(MRN) %>%
summarise(
cutoff = s,
sterdays.to.iostart = glue_collapse(unique(days.to.iostart), sep = ",")
)
}
doseconstruct <- bind_rows(doseconstruct) %>%
spread(key = cutoff, value = sterdays.to.iostart)
colnames(doseconstruct) <- c("MRN", paste("days.prescribed.", stratcuts, sep = ""))
dosevits <- db %>%
mutate(MRN = record_id) %>%
select(MRN, days, vitalstatus) %>%
left_join(doseconstruct) %>%
select(-MRN)
grep("placebo", thromplate, ignore.case = TRUE)
iostart <- db %>%
select(record_id, iostart) %>%
mutate(iostart = as.Date(iostart, format = "%F")) %>%
mutate(MRN = record_id) %>%
select(-record_id)
thromplate <- thromplate %>%
mutate(MRN = as.character(MRN)) %>%
left_join(iostart)
thromplate$iostart <- as.Date(thromplate$iostart, format = "%F")
thromplate$START_DATE <- as.Date(thromplate$START_DATE, format = "%F")
thromplate$days.to.iostart <- thromplate$START_DATE - thromplate$iostart
thromplate$days.to.iostart <- as.numeric(thromplate$days.to.iostart)
thrombins <- c("Acova", "Argatroban", "Dabigatran", "Dabigatran etexilate", "Desirudin", "Iprivask", "Lepirudin", "Pradaxa", "Refludan",	"Vorapaxar","Zontivity")
thrombins <- glue_collapse(thrombins, sep = "|")
platelets <- c("Aspirin", "Clopidogrel", "Plavix", "Aggrenox", "Ticlopidine", "Ticlid", "Prasugrel", "Effient", "Ticagrelor", "Brilinta", "Cangrelor", "Dipyridamole", "Persantine", "Sildenafil", "Viagra", "Revatio", "Cilostazol", "Pletal")
platelets <- glue_collapse(platelets, sep = "|")
thromplate <- thromplate %>%
mutate(inhib = ifelse(grepl(thrombins, GENERIC_NAME, ignore.case = TRUE), "thrombin.days.to.iostart", ifelse(grepl(platelets, GENERIC_NAME, ignore.case = TRUE), "platelet.days.to.iostart", 0))) %>%
filter(inhib == "thrombin.days.to.iostart" | inhib == "platelet.days.to.iostart")
thromplate.join <- thromplate %>%
filter(!is.na(days.to.iostart)) %>%
group_by(MRN, inhib) %>%
summarise(days.to.iostart = glue_collapse(unique(days.to.iostart), sep = ",")) %>%
spread(key = "inhib", value = "days.to.iostart")
db <- thromplate.join %>%
ungroup() %>%
mutate(record_id = MRN) %>%
select(-MRN) %>%
left_join(db, .)
thromplatcount <- unique(thromplate[,c("MRN", "inhib")])
thromplatcount %>%
group_by(inhib) %>%
tally()
adminroute <- meds %>%
group_by(abxClass, ROUTE) %>%
tally()
to.other <- c("breast cancer", "merkel cell carcinoma", "pancreatic cancer", "Prostate", "small cell lung cancer", "colon cancer", "Hodgkin lymphoma")
db2$cancer.name <-  ifelse(db2$cancer.name %in% to.other, "Other", db2$cancer.name)
capcanc <- as.data.frame(cbind(cancer.name = c("Other", "bladder cancer", "head and neck carcinoma", "melanoma", "non-small cell lung cancer", "renal cell carcinoma", "Sarcoma"), cap.cancer.name = c("Other", "Bladder Cancer", "Head and Neck Carcinoma", "Melanoma", "Non-Small Cell Lung Cancer", "Renal Cell Carcinoma", "Sarcoma")))
gitdata <- db2 %>%
left_join(capcanc) %>%
mutate(cancer.name = cap.cancer.name) %>%
left_join(db.oth.med.break) %>%
select(days, vitalstatus, cancer.name, abxdays.to.iostart, contains("to.start"), oth.presc.28, h2b_iostart, nsaid_iostart, ppi, statin, ecog, bmi.calc, sex, age, staging, immunotherapy, other_io)
saveRDS(gitdata, "../data/db-for-git.RDS")
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(flextable)
library(UpSetR)
library(glue)
library(tibble)
db <- readRDS("../data/from_processing/deidentdb_timing.RDS")
db <- readRDS("db.RDS")
sterkey <- read.table("steroid-dbid-key.tsv")
sterkey <- sterkey %>%
select(-Drug.name)
sterkey <- sterkey[!duplicated(sterkey),]
db <- readRDS("db.RDS")
sterkey <- read.table("steroid-dbid-key.tsv")
sterkey <- sterkey %>%
select(-Drug.name)
sterkey <- sterkey[!duplicated(sterkey),]
check.window <- function(vect, per){
wind <- per[1]:per[2]
wind <- glue_collapse(as.character(wind), sep = ",|,")
wind <- paste(",", wind, ",", sep = "")
ifelse(grepl(pattern = wind, x = vect), 1, 0)
}
abxclasses <- c("BetaLactam", "Macrolide",  "Other.Antibacterial", "Fluoroquinolone", "Tetracycline", "Vancomycin", "Trimethoprim", "Clindamycin", "Metronidazole")
statesofinterest <- c(abxclasses, as.character(sterkey$Generic.ID))
edges <- c(-28,28)
for(s in statesofinterest){
db[[paste(s, ".to.start", sep = "")]] <- paste(",", db[[paste(s, ".to.start", sep = "")]], ",", sep = "")
db[[s]] <- check.window(db[[paste(s, ".to.start", sep = "")]], edges)
}
db$Other.Steroid <- ifelse(db$Betamthasone == 1 | db$Fludrocortisone == 1 | db$Prednisolone == 1, 1, 0)
db <- db %>%
mutate(abx.28.28 = check.window(paste(",", abxdays.to.iostart, ",", sep = ""), edges),
steroid.28.28 = check.window(paste(",", sterdays.to.start, ",", sep = ""), edges))
othatb.tab <- db %>%
filter(!is.na(oth.presc.28)) %>%
group_by(oth.presc.28) %>%
tally() %>%
mutate(ATB = oth.presc.28) %>%
select(ATB, n)
othatb.tab %>%
flextable()
othster.tab <- db %>%
filter(Other.Steroid == 1) %>%
summarise(Betamethasone = sum(Betamthasone),
Fludrocortisone = sum(Fludrocortisone),
Prednisolone = sum(Prednisolone),
Total = sum(Other.Steroid)) %>%
t() %>%
as.data.frame() %>%
rownames_to_column(var = "Steroid") %>%
mutate(n = V1) %>%
select(-V1)
othster.tab %>%
flextable()
othster.tab <- db %>%
filter(Other.Steroid == 1) %>%
summarise(Betamethasone = sum(Betamthasone),
Fludrocortisone = sum(Fludrocortisone),
Prednisolone = sum(Prednisolone),
Total = sum(Other.Steroid)) %>%
t() %>%
as.data.frame() %>%
rownames_to_column(var = "Steroid") %>%
mutate(n = as.integer(V1)) %>%
select(-V1)
othster.tab %>%
flextable()
meds_iostart <- c("h2b_iostart", "nsaid_iostart", "ppi", "statin", "steroid.28.28", "abx.28.28")
dat.for.upset <- db %>%
select(meds_iostart)
colnames(dat.for.upset) <- c("H2B", "NSAIDs", "PPI", "Statins", "Steroids", "Antibiotics")
png("../figures/supplemental/upset_all-meds-confounding.png", units = "in", height = 5, width = 8, res = 600)
#png("../figures/supplemental/upset_all-meds-confounding.png", units = "in", height = 5, width = 8, res = 600)
upset(dat.for.upset, main.bar.color = "darkred", mainbar.y.label = "Number of Patients", matrix.color = "dark blue", sets.x.label = "")
#dev.off()
#png("../figures/supplemental/upset_atb.png", units = "in", height = 5, width = 8, res = 600)
upset(dat.for.upset, main.bar.color = "darkred", mainbar.y.label = "Number of Patients", matrix.color = "dark blue", sets.x.label = "", nsets = 9)
#dev.off()
dat.for.upset <- db %>%
select(Triamcinolone, Prednisone, Hydrocortisone, Methylprednisone, Dexamethosone, Hydrocortisone, Other.Steroid)
colnames(dat.for.upset)[6] <- "Other Steroid"
#png("../figures/supplemental/upset_steroid.png", units = "in", height = 5, width = 8, res = 600)
upset(dat.for.upset, main.bar.color = "darkred", mainbar.y.label = "Number of Patients", matrix.color = "dark blue", sets.x.label = "", nsets = 7)
#dev.off()
